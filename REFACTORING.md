# Refactoring targets

## 1. TradingSystem god object
`TradingSystem` in `main.py` wires WebSocket ingest, REST polling, analytics, signal generation, execution, risk, monitoring, persistence, metrics, and alerting inside a single class. Initialization alone instantiates more than a dozen collaborators, handles snapshot persistence, and mutates shared analytics state (`self.analytics_engine.on_trade`, AVWAP snapshots, microstructure contamination flags, etc.). The orchestration methods then embed operational logic for trades, order book events, and audit logging directly in the same class. This violates single-responsibility boundaries and makes the runtime hard to test or reuse. Extract domain-specific services (ingest coordination, analytics fan-out, signal lifecycle, execution/risk orchestration) behind explicit interfaces so the event loop only sequences them. 【F:main.py†L36-L200】

## 2. DivergenceDetector sync logic stub
`DivergenceDetector.check_rsi_divergence` computes RSI context but the intended synchronization guard is an orphan expression (`abs(swing2["bar"] - swing1["bar"])`) that is never assigned or compared to `self.sync_tolerance`. That renders the `sync_tolerance` setting unused and allows arbitrarily distant swing pairs to be marked as divergences, distorting scoring. Refactor the detector so bar-distance validation is enforced consistently across all divergence checks and dead code is eliminated. 【F:strategy/divergence.py†L22-L75】

## 3. MarketDataManager handler plumbing
`MarketDataManager` stores nine separate handler attributes and reimplements identical `if handler: await handler(...)` wrappers for every event type. Type annotations claim each handler returns an `asyncio.Task`, but call sites await plain coroutines, signaling a mismatch. Replace the per-field boilerplate with a dict-driven dispatcher that registers async callables, normalizes typing to `Callable[..., Awaitable[None]]`, and centralizes error handling/backpressure instrumentation; this improves extensibility when more feeds are added. 【F:ingest/market_data_manager.py†L10-L110】

## 4. ExecutionManager mixing transport, strategy, and paper state
`ExecutionManager` reads mutable configuration at import time, owns Binance REST client lifecycle, embeds retry recursion, handles paper order bookkeeping, records metrics, and exposes risk metadata (tick size, contract multiplier) in one class. The logic jumps between async REST flows and synchronous paper simulations, sharing dictionaries such as `_paper_orders` and `_market_meta`. Refactor into separate components (REST transport adapter, paper portfolio simulator, metadata cache) so error handling, retries, and paper/live branching can be independently tested and swapped. 【F:strategy/execution.py†L12-L383】

## 5. DataPersister duplicated buffering and SQL
`DataPersister` manages six independent buffers, each with almost identical insertion and flushing logic, and a manual `_enforce_bounds` switch. Every `flush_*` method reopens a connection, runs `executemany` with inline SQL, and manually clears buffers, making it easy to diverge behavior across data types. Introduce a declarative registry that maps buffer names to table schemas and dispatches through shared batching, retention, and persistence primitives; this will reduce copy/paste and allow consistent durability guarantees. 【F:ingest/persister.py†L13-L200】

## 6. Configuration system split-brain
`config.__init__` exports both `config` (new loader) and `legacy_config`, while most modules import `config` and immediately treat it as if nested attributes exist. The new loader simply returns nested dicts without env interpolation or attribute proxies beyond the top level, whereas `_legacy_config.py` still performs environment-variable expansion and exposes typed sections. The coexistence encourages accidental reliance on whichever object happens to satisfy attribute access, complicating validation and secrets handling. Consolidate on a single loader that preserves env substitution and typed sections, and remove the dead legacy singleton to eliminate divergent behavior. 【F:config/__init__.py†L1-L6】【F:config/config_loader.py†L1-L32】【F:config/_legacy_config.py†L9-L115】
